<!doctype html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Arquivos e Dependências | calcularkm</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'] },
          colors: {
            brand: { 50:'#f2fbff',100:'#e6f6ff',200:'#ccecff',300:'#a3deff',400:'#6fc8ff',500:'#3fb1ff',600:'#1f89d6',700:'#186ba8',800:'#134f7b',900:'#0d3552' }
          }
        }
      },
      darkMode: 'class'
    };
  </script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    pre, code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace }
    .code-block { background: rgba(2, 6, 23, 0.04) }
    .dark .code-block { background: rgba(255,255,255,0.06) }
  </style>
</head>
<body class="font-sans bg-white text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <!-- Barra superior -->
  <header class="sticky top-0 z-50 backdrop-blur bg-white/70 dark:bg-slate-900/60 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="#" class="flex items-center gap-2 font-semibold">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-brand-600 text-white">km</span>
        <span>calcularkm</span>
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#sumario" class="hover:text-brand-600">Sumário</a>
        <a href="#fluxo" class="hover:text-brand-600">Fluxo</a>
        <a href="#arquivos" class="hover:text-brand-600">Arquivos</a>
        <a href="#dependencias" class="hover:text-brand-600">Dependências</a>
        <a href="#execucao" class="hover:text-brand-600">Execução</a>
        <a href="#extensao" class="hover:text-brand-600">Como estender</a>
      </nav>
      <button id="themeToggle" class="rounded-md px-3 py-2 text-sm border border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800">
        Alternar tema
      </button>
    </div>
  </header>

  <!-- Hero -->
  <section class="bg-gradient-to-br from-brand-50 via-white to-brand-100 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-16 grid md:grid-cols-2 gap-8 items-center">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight">Mapa de Arquivos e Dependências</h1>
        <p class="mt-4 text-slate-600 dark:text-slate-300">
          Entenda a importância, função e como cada arquivo se relaciona com os demais na API calcularkm.
        </p>
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#arquivos" class="inline-flex items-center gap-2 rounded-md bg-brand-600 px-4 py-2 text-white hover:bg-brand-700">Ver arquivos</a>
          <a href="#fluxo" class="inline-flex items-center gap-2 rounded-md border border-slate-300 dark:border-slate-700 px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-800">Ver fluxo</a>
        </div>
      </div>
      <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-4 code-block">
        <pre class="text-sm overflow-auto"><code>// Estrutura
pom.xml
└─ src/main/java/com/treinadev/calcularkm/
   ├─ DistanceController.java
   ├─ DistanceService.java
   ├─ DistanceRequest.java
   ├─ DistanceResponse.java
   └─ FormatadorLocalizacao.java

// Relações
Controller → Service
Controller ↔ DTOs (Request/Response)
Validation (jakarta) → DistanceRequest
FormatadorLocalizacao (Locale/NumberFormat) → formatação da resposta
Jackson → serializa Response</code></pre>
      </div>
    </div>
  </section>

  <!-- Conteúdo -->
  <main class="max-w-6xl mx-auto px-4 py-12 space-y-16">
    <!-- Sumário -->
    <section id="sumario" class="space-y-4">
      <h2 class="text-2xl font-semibold">Sumário</h2>
      <p>Este documento descreve, em ordem lógica, cada arquivo do projeto, seu papel, impacto e dependências.</p>
      <ol class="list-decimal pl-6 space-y-2">
        <li>pom.xml — configuração e dependências Maven.</li>
        <li>DistanceController.java — entrada HTTP, orquestra a lógica e formata resposta.</li>
        <li>DistanceService.java — cálculo da distância (Haversine) e validação defensiva.</li>
        <li>DistanceRequest.java — contrato de entrada com validação.</li>
        <li>DistanceResponse.java — contrato de saída (record imutável).</li>
        <li>FormatadorLocalizacao.java — utilitário central de formatação (números, datas e moedas).</li>
      </ol>
    </section>

    <!-- Fluxo -->
    <section id="fluxo" class="space-y-4">
      <h2 class="text-2xl font-semibold">Fluxo de requisição e resposta</h2>
      <div class="rounded-lg border border-slate-200 dark:border-slate-800 p-4 code-block">
        <pre class="text-sm overflow-auto"><code>Cliente
  ↓ HTTP POST /distance (JSON + Accept-Language)
DistanceController
  → @Valid valida DistanceRequest (lat/long)
  → resolve Locale (Accept-Language → Locale)
  → chama DistanceService.calculateKm(...)
DistanceService
  → valida coordenadas (defesa adicional)
  → Haversine + BigDecimal(2 casas, HALF_UP)
  → retorna double (km)
DistanceController
  → FormatadorLocalizacao.formatarNumero(distanceKm, locale)
  → cria DistanceResponse(distanceKm, distanceKmFormatted)
  → ResponseEntity.ok(JSON)
Cliente
  ← JSON serializado pelo Jackson</code></pre>
      </div>
    </section>

    <!-- Arquivos -->
    <section id="arquivos" class="space-y-8">
      <h2 class="text-2xl font-semibold">Arquivos e responsabilidades</h2>

      <!-- pom.xml -->
      <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-6">
        <h3 class="text-lg font-semibold">1) pom.xml</h3>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
          Define o Spring Boot 4.0.1, Java 21 e as dependências essenciais:
        </p>
        <ul class="list-disc pl-6 text-sm space-y-1">
          <li>spring-boot-starter-web — MVC, Jackson e servidor embutido.</li>
          <li>spring-boot-starter-validation — Bean Validation (jakarta) para @Valid.</li>
          <li>lombok (opcional) — reduz boilerplate em DTOs/classes.</li>
          <li>spring-boot-starter-test — JUnit, Mockito, Spring Test (escopo test).</li>
        </ul>
        <p class="mt-2 text-sm">
          Impacto: sem estas dependências, o controller não inicia, o JSON não é serializado e a validação não funciona.
        </p>
      </div>

      <!-- DistanceController.java -->
      <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-6">
        <h3 class="text-lg font-semibold">2) DistanceController.java</h3>
        <p class="mt-2 text-sm">
          Ponto de entrada HTTP (REST). Recebe o DistanceRequest, chama o DistanceService e devolve DistanceResponse.
        </p>
        <ul class="list-disc pl-6 text-sm space-y-1">
          <li>Depende de DistanceService (injeção via construtor).</li>
          <li>Usa @Valid para acionar validação do DistanceRequest.</li>
          <li>Lê Accept-Language e resolve Locale; formata número com FormatadorLocalizacao.</li>
          <li>Serializa JSON via Jackson (parte do starter web).</li>
        </ul>
        <div class="mt-3 rounded-lg border border-slate-200 dark:border-slate-800 p-4 code-block">
          <pre class="text-sm overflow-auto"><code>// Trecho chave
double km = distanceService.calculateKm(req.getUserLat(), req.getUserLng(), req.getTargetLat(), req.getTargetLng());
Locale locale = resolveLocale(acceptLanguage);
String fmt = FormatadorLocalizacao.formatarNumero(km, locale);
return ResponseEntity.ok(new DistanceResponse(km, fmt));</code></pre>
        </div>
      </div>

      <!-- DistanceService.java -->
      <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-6">
        <h3 class="text-lg font-semibold">3) DistanceService.java</h3>
        <p class="mt-2 text-sm">
          Contém a lógica de negócio: cálculo da distância usando Haversine com raio WGS84 e arredondamento determinístico.
        </p>
        <ul class="list-disc pl-6 text-sm space-y-1">
          <li>Não expõe HTTP; é chamado pelo controller.</li>
          <li>Valida coordenadas (defesa além do @Valid do controller).</li>
          <li>Retorna km como double; controller cuida da formatação e resposta.</li>
        </ul>
        <div class="mt-3 rounded-lg border border-slate-200 dark:border-slate-800 p-4 code-block">
          <pre class="text-sm overflow-auto"><code>// Pontos de precisão
double c = 2.0 * Math.asin(Math.sqrt(a));
double distance = EARTH_RADIUS_KM * c;
double rounded = BigDecimal.valueOf(distance)
  .setScale(2, RoundingMode.HALF_UP)
  .doubleValue();</code></pre>
        </div>
      </div>

      <!-- DistanceRequest.java -->
      <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-6">
        <h3 class="text-lg font-semibold">4) DistanceRequest.java</h3>
        <p class="mt-2 text-sm">
          DTO de entrada. Define o contrato de requisição e as regras de validação de latitude/longitude.
        </p>
        <ul class="list-disc pl-6 text-sm space-y-1">
          <li>Usado pelo controller para desserializar JSON.</li>
          <li>Anotações jakarta.validation (@DecimalMin/@DecimalMax) garantem faixas válidas.</li>
          <li>Evita cálculos com dados inválidos e retorna 400 automaticamente em caso de erro.</li>
        </ul>
        <div class="mt-3 rounded-lg border border-slate-200 dark:border-slate-800 p-4 code-block">
          <pre class="text-sm overflow-auto"><code>@DecimalMin(value = "-90") @DecimalMax(value = "90")  private double userLat;
@DecimalMin(value = "-180") @DecimalMax(value = "180") private double userLng;
@DecimalMin(value = "-90") @DecimalMax(value = "90")  private double targetLat;
@DecimalMin(value = "-180") @DecimalMax(value = "180") private double targetLng;</code></pre>
        </div>
      </div>

      <!-- DistanceResponse.java -->
      <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-6">
        <h3 class="text-lg font-semibold">5) DistanceResponse.java</h3>
        <p class="mt-2 text-sm">
          DTO de saída. Record imutável (Java 21) com o valor bruto em km e a versão formatada segundo Locale.
        </p>
        <ul class="list-disc pl-6 text-sm space-y-1">
          <li>Serializado automaticamente por Jackson.</li>
          <li>Consumido por clientes e pelo playground do manual.</li>
        </ul>
        <div class="mt-3 rounded-lg border border-slate-200 dark:border-slate-800 p-4 code-block">
          <pre class="text-sm overflow-auto"><code>public record DistanceResponse(double distanceKm, String distanceKmFormatted) { }</code></pre>
        </div>
      </div>

      <!-- FormatadorLocalizacao.java -->
      <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-6">
        <h3 class="text-lg font-semibold">6) FormatadorLocalizacao.java</h3>
        <p class="mt-2 text-sm">
          Utilitário central para formatação dependente de Locale (números, moedas, datas).
          Mantém a regra de 2 casas decimais para leituras em endpoints.
        </p>
        <ul class="list-disc pl-6 text-sm space-y-1">
          <li>Usado pelo DistanceController para padronizar formatação de distanceKmFormatted.</li>
          <li>Facilita reutilização futura em outros endpoints.</li>
        </ul>
        <div class="mt-3 rounded-lg border border-slate-200 dark:border-slate-800 p-4 code-block">
          <pre class="text-sm overflow-auto"><code>public final class FormatadorLocalizacao {
  public static String formatarNumero(double valor, Locale locale) {
    NumberFormat nf = NumberFormat.getNumberInstance(locale);
    nf.setMaximumFractionDigits(2);
    return nf.format(valor);
  }
}</code></pre>
        </div>
      </div>
    </section>

    <!-- Dependências cruzadas -->
    <section id="dependencias" class="space-y-4">
      <h2 class="text-2xl font-semibold">Dependências entre arquivos</h2>
      <div class="rounded-lg border border-slate-200 dark:border-slate-800 p-4 code-block">
        <pre class="text-sm overflow-auto"><code>pom.xml
  ├─ spring-boot-starter-web → habilita @RestController, Jackson e servidor
  ├─ spring-boot-starter-validation → habilita @Valid e anotações jakarta.validation
  └─ lombok (opcional) → reduz boilerplate em DTOs

DistanceController.java
  ├─ Depende de DistanceService (injeção)
  ├─ Consome DistanceRequest (desserialização e @Valid)
  ├─ Produz DistanceResponse (serialização JSON)
  └─ Usa FormatadorLocalizacao + Locale (Accept-Language)

DistanceService.java
  └─ Oferece calculateKm(...) para o controller; valida e calcula

DistanceRequest.java
  └─ Fornece contrato de entrada e regras de validação

DistanceResponse.java
  └─ Fornece contrato de saída (record) serializado por Jackson

FormatadorLocalizacao.java
  └─ Oferece formatação padronizada para números, moedas e datas</code></pre>
      </div>
    </section>

    <!-- Execução e contrato -->
    <section id="execucao" class="space-y-6">
      <h2 class="text-2xl font-semibold">Execução e contratos</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div class="rounded-lg border border-slate-200 dark:border-slate-800 p-4 code-block">
          <h3 class="font-semibold mb-2">Comandos</h3>
          <pre class="text-sm overflow-auto"><code>mvn clean package
mvn spring-boot:run
# ou
java -jar target\calcularkm-0.0.1-SNAPSHOT.jar</code></pre>
        </div>
        <div class="rounded-lg border border-slate-200 dark:border-slate-800 p-4">
          <h3 class="font-semibold mb-2">Contratos JSON</h3>
          <div class="space-y-3">
            <div>
              <div class="text-sm font-semibold">Request</div>
              <pre class="text-sm overflow-auto code-block p-3 rounded"><code>{
  "userLat": -23.550520,
  "userLng": -46.633308,
  "targetLat": -22.906847,
  "targetLng": -43.172896
}</code></pre>
            </div>
            <div>
              <div class="text-sm font-semibold">Response</div>
              <pre class="text-sm overflow-auto code-block p-3 rounded"><code>{
  "distanceKm": 357.12,
  "distanceKmFormatted": "357,12"
}</code></pre>
            </div>
          </div>
        </div>
      </div>
      <p class="text-slate-600 dark:text-slate-300">Porta padrão: 8080 — http://localhost:8080</p>
    </section>

    <!-- Extensão -->
    <section id="extensao" class="space-y-4">
      <h2 class="text-2xl font-semibold">Como estender o projeto</h2>
      <ul class="list-disc pl-6 space-y-2">
        <li>Suporte a milhas: adicionar conversão (km × 0.621371) e novo campo no DistanceResponse.</li>
        <li>Tratamento de erros: criar um ControllerAdvice para padronizar e localizar mensagens.</li>
        <li>Internacionalização: adicionar ResourceBundle para mensagens e usar Locale.resolve.</li>
        <li>Testes: ampliar cobertura com cenários extremos e diferentes Accept-Language.</li>
        <li>Formatação adicional: reutilizar FormatadorLocalizacao para datas e moedas em outros endpoints.</li>
      </ul>
    </section>
  </main>

  <!-- Rodapé -->
  <footer class="mt-12 border-t border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-8 text-sm text-slate-600 dark:text-slate-400">
      <div>calcularkm · Spring Boot 4.0.1 · Java 21</div>
      <div class="mt-2">Projeto em: c:\dev\java\java-localizacao</div>
    </div>
  </footer>

  <!-- Script -->
  <script>
    // Alternar tema claro/escuro (persistência em localStorage)
    const themeToggle = document.getElementById('themeToggle');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme');
    function applyTheme(mode) {
      if (mode === 'dark') document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
      localStorage.setItem('theme', mode);
    }
    applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
    themeToggle.addEventListener('click', () => {
      const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(next);
    });
  </script>
</body>
</html>